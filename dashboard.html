<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relatório de Ação - EXÉRCITO</title>
  <link rel="assets/eb.png" type="image/png">
  <link rel="stylesheet" href="style.css">

  <style>
    body { background-color: #1e1e1e; color: #fff; font-family: Arial, sans-serif; }

    .page {
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 34px;
    }

    .hero {
      margin-top: 14px;
      border-radius: 18px;
      padding: 18px 16px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 45px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }

    .hero h1 { margin: 0; font-size: 22px; letter-spacing: .2px; }
    .hero p { margin: 8px 0 0; opacity: .82; line-height: 1.35; }

    .panel {
      margin-top: 14px;
      border-radius: 18px;
      padding: 14px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(6px);
    }

    .panel h2 { margin: 0 0 12px 0; font-size: 16px; opacity: .95; }

    /* Card “estilo login” */
    .login-card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .full { grid-column: 1 / -1; }

    /* Escopado na página (não afeta menu/logout) */
    .page input, .page button, .page select, .page textarea {
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color: #fff;
      outline: none;
      box-sizing: border-box;
    }
    .page input:focus { filter: brightness(1.05); }

    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .btn-row button { flex: 1; min-width: 160px; }

    #listaOcorrencias { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }

    .operacao-card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.20);
      transition: transform .16s ease, filter .16s ease;
    }
    .operacao-card:hover { transform: translateY(-2px); filter: brightness(1.03); }

    .title-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .title-row strong { font-size: 15px; }
    .chip {
      font-size: 12px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      white-space: nowrap;
      opacity: .9;
    }

    .meta { opacity: .9; line-height: 1.35; }
    .meta div { margin: 3px 0; }

    .acoes {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .acoes button { width: auto; padding: 10px 12px; border-radius: 10px; font-weight: 800; cursor: pointer; }
    .btn-editar { background: #3498db; border: none; }
    .btn-excluir { background: #e74c3c; border: none; }

    .muted { opacity: .75; font-size: 12px; }

    @media (max-width: 760px) {
      .grid { grid-template-columns: 1fr; }
      .btn-row button { min-width: 100%; }
      .title-row { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>

<body>
  <!-- Menu dinâmico -->
  <script src="menu-loader.js"></script>

  <main class="page">
    <section class="hero">
      <h1>Relatório de Ação - EXÉRCITO</h1>
      <p>Registre operações e consulte rapidamente as ações cadastradas no sistema.</p>
    </section>

    <section class="panel">
      <h2>Registrar Operação</h2>

      <div class="login-card">

        <form id="bopeForm">
          <div class="grid">
            <input class="full" type="text" id="tipo" placeholder="Tipo de Operação" required>
            <input class="full" type="text" id="responsavel" placeholder="Oficial Responsável" required>

            <input class="full" type="text" id="executor" placeholder="Militar/Policial que executou a ação" required>

            <textarea class="full" id="oficiaisNomes" placeholder="Nomes dos oficiais envolvidos (separe por vírgula)"></textarea>
            <input type="number" id="oficiaisQtd" placeholder="Qtd. de oficiais envolvidos" min="0" step="1">

            <select class="full" id="resultado">
              <option value="">Resultado da operação (opcional)</option>
              <option value="Ganhou">Ganhou</option>
              <option value="Perdeu">Perdeu</option>
            </select>

            <textarea class="full" id="individuos" placeholder="Nome(s) ou passaporte/ID dos indivíduos envolvidos (separe por linha ou vírgula)"></textarea>
            <input type="number" id="individuosQtd" placeholder="Qtd. de indivíduos" min="0" step="1">

            <select id="armamentoRecolhido">
              <option value="">Armamento recolhido? (opcional)</option>
              <option value="sim">Sim</option>
              <option value="nao">Não</option>
            </select>
            <input type="number" id="armasQtd" placeholder="Qtd. de armas recolhidas" min="0" step="1">

            <input type="number" id="presosQtd" placeholder="Qtd. presos" min="0" step="1">
            <input type="number" id="liberadosQtd" placeholder="Qtd. liberados" min="0" step="1">

            <input class="full" type="number" id="dinheiroQtd" placeholder="Qtd. de dinheiro apreendido (R$)" min="0" step="0.01">

            <input type="text" id="melhorAtirador" placeholder="Melhor Atirador (opcional)">
            <input type="text" id="melhorModulacao" placeholder="Melhor Modulação (opcional)">

            <input class="full" type="text" id="responsavelGuarnicao" placeholder="Responsável pela Guarnição (opcional)">
            <input type="number" id="tempoMedio" placeholder="Tempo Médio (min) (opcional)">
            <input type="date" id="data" required>
          </div>

          <div class="btn-row">
            <button type="submit" class="btn-green" id="btnSalvar">Registrar Operação</button>
          </div>
        </form>

        <div class="muted" id="formHint"></div>
      </div>
    </section>

    <section class="panel">
      <h2>Operações Registradas</h2>
      <div id="listaOcorrencias"></div>
    </section>
  </main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    deleteDoc,
    updateDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

  // Permissões
  const usuario = sessionStorage.getItem("usuario");
  const nivel = sessionStorage.getItem("nivel"); // ✅ só COMANDO pode editar/excluir

  if (!usuario) window.location.href = "index.html";

  const app = initializeApp({
    apiKey: "AIzaSyC0ZrUAeNGBTZefNuoL9Qf9iJBtpaIwG7M",
    authDomain: "sistema-bope.firebaseapp.com",
    projectId: "sistema-bope"
  });

  const db = getFirestore(app);

  const bopeForm = document.getElementById("bopeForm");
  const listaOcorrencias = document.getElementById("listaOcorrencias");
  const formHint = document.getElementById("formHint");
  const btnSalvar = document.getElementById("btnSalvar");

  const tipo = document.getElementById("tipo");
  const responsavel = document.getElementById("responsavel");
  const executor = document.getElementById("executor");
  const oficiaisNomes = document.getElementById("oficiaisNomes");
  const oficiaisQtd = document.getElementById("oficiaisQtd");
  const resultado = document.getElementById("resultado");
  const individuos = document.getElementById("individuos");
  const individuosQtd = document.getElementById("individuosQtd");
  const armamentoRecolhido = document.getElementById("armamentoRecolhido");
  const armasQtd = document.getElementById("armasQtd");
  const presosQtd = document.getElementById("presosQtd");
  const liberadosQtd = document.getElementById("liberadosQtd");
  const dinheiroQtd = document.getElementById("dinheiroQtd");
  const melhorAtirador = document.getElementById("melhorAtirador");
  const melhorModulacao = document.getElementById("melhorModulacao");
  const responsavelGuarnicao = document.getElementById("responsavelGuarnicao");
  const tempoMedio = document.getElementById("tempoMedio");
  const dataInput = document.getElementById("data");

  // Estado de edição (somente comando)
  let editId = null;

  function linha(label, value) {
    const v = (value ?? "").toString().trim();
    if (!v) return "";
    return `<div><strong>${label}:</strong> ${v}</div>`;
  }

  function setModoEdicao(ativo) {
    if (ativo) {
      btnSalvar.textContent = "Salvar Alterações";
      formHint.textContent = "Modo edição ativo: altere os campos e clique em Salvar Alterações.";
    } else {
      btnSalvar.textContent = "Registrar Operação";
      formHint.textContent = "";
      editId = null;
    }
  }

  async function renderOcorrencias() {
    listaOcorrencias.innerHTML = "";
    const snapshot = await getDocs(collection(db, "operacoes"));

    if (snapshot.empty) {
      listaOcorrencias.innerHTML = `<div class="login-card">
<p class="muted">Nenhuma operação registrada ainda.</p></div>`;
      return;
    }

    snapshot.forEach(docSnap => {
      const o = docSnap.data();
      const id = docSnap.id;

      const div = document.createElement("div");
      div.className = "operacao-card";

      div.innerHTML = `
        <div class="title-row">
          <strong>${(o.tipo || "Operação").toString()}</strong>
          <span class="chip">${(o.data || "-").toString()}</span>
        </div>

        <div class="meta">
          ${linha("Executou", o.executor)}
          ${linha("Oficiais envolvidos", o.oficiaisNomes)}
          ${linha("Qtd. oficiais", o.oficiaisQtd)}
          ${linha("Resultado", o.resultado)}
          ${linha("Indivíduos (nome/ID)", o.individuos)}
          ${linha("Qtd. indivíduos", o.individuosQtd)}
          ${linha("Armamento recolhido", o.armamentoRecolhido)}
          ${linha("Qtd. armas", o.armasQtd)}
          ${linha("Presos", o.presosQtd)}
          ${linha("Liberados", o.liberadosQtd)}
          ${linha("Dinheiro apreendido", o.dinheiroQtd ? `R$ ${o.dinheiroQtd}` : "")}
          ${linha("Responsável", o.responsavel)}
          ${linha("Melhor Atirador", o.melhorAtirador)}
          ${linha("Melhor Modulação", o.melhorModulacao)}
          ${linha("Guarnição", o.responsavelGuarnicao)}
          ${linha("Tempo Médio", o.tempoMedio ? `${o.tempoMedio} min` : "")}
        </div>

        ${nivel === "comando" ? `
          <div class="acoes">
            <button class="btn-editar">Editar</button>
            <button class="btn-excluir">Excluir</button>
          </div>
        ` : ""}
      `;

      // ✅ Só comando recebe handlers
      if (nivel === "comando") {
        const btnExcluirEl = div.querySelector(".btn-excluir");
        const btnEditarEl = div.querySelector(".btn-editar");

        if (btnExcluirEl) {
          btnExcluirEl.onclick = async () => {
            if (!confirm("Deseja excluir esta operação?")) return;
            await deleteDoc(doc(db, "operacoes", id));
            renderOcorrencias();
          };
        }

        if (btnEditarEl) {
          btnEditarEl.onclick = () => {
            editId = id;

            tipo.value = o.tipo || "";
            responsavel.value = o.responsavel || "";
            executor.value = o.executor || "";
            oficiaisNomes.value = o.oficiaisNomes || "";
            oficiaisQtd.value = o.oficiaisQtd || "";
            resultado.value = o.resultado || "";
            individuos.value = o.individuos || "";
            individuosQtd.value = o.individuosQtd || "";
            armamentoRecolhido.value = o.armamentoRecolhido || "";
            armasQtd.value = o.armasQtd || "";
            presosQtd.value = o.presosQtd || "";
            liberadosQtd.value = o.liberadosQtd || "";
            dinheiroQtd.value = o.dinheiroQtd || "";
            melhorAtirador.value = o.melhorAtirador || "";
            melhorModulacao.value = o.melhorModulacao || "";
            responsavelGuarnicao.value = o.responsavelGuarnicao || "";
            tempoMedio.value = o.tempoMedio || "";
            dataInput.value = o.data || "";

            setModoEdicao(true);
            window.scrollTo({ top: 0, behavior: "smooth" });
          };
        }
      }

      listaOcorrencias.appendChild(div);
    });
  }

  bopeForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Se está em modo edição, só COMANDO pode salvar alterações
    if (editId) {
      if (nivel !== "comando") return;

      await updateDoc(doc(db, "operacoes", editId), {
        tipo: tipo.value,
        responsavel: responsavel.value,
        executor: executor.value,
        oficiaisNomes: oficiaisNomes.value,
        oficiaisQtd: oficiaisQtd.value,
        resultado: resultado.value,
        individuos: individuos.value,
        individuosQtd: individuosQtd.value,
        armamentoRecolhido: armamentoRecolhido.value,
        armasQtd: armasQtd.value,
        presosQtd: presosQtd.value,
        liberadosQtd: liberadosQtd.value,
        dinheiroQtd: dinheiroQtd.value,
        melhorAtirador: melhorAtirador.value,
        melhorModulacao: melhorModulacao.value,
        responsavelGuarnicao: responsavelGuarnicao.value,
        tempoMedio: tempoMedio.value,
        data: dataInput.value
      });

      bopeForm.reset();
      setModoEdicao(false);
      renderOcorrencias();
      return;
    }

    // Cadastro normal (mantém como estava)
    await addDoc(collection(db, "operacoes"), {
      tipo: tipo.value,
      responsavel: responsavel.value,
      executor: executor.value,
      oficiaisNomes: oficiaisNomes.value,
      oficiaisQtd: oficiaisQtd.value,
      resultado: resultado.value,
      individuos: individuos.value,
      individuosQtd: individuosQtd.value,
      armamentoRecolhido: armamentoRecolhido.value,
      armasQtd: armasQtd.value,
      presosQtd: presosQtd.value,
      liberadosQtd: liberadosQtd.value,
      dinheiroQtd: dinheiroQtd.value,
      melhorAtirador: melhorAtirador.value,
      melhorModulacao: melhorModulacao.value,
      responsavelGuarnicao: responsavelGuarnicao.value,
      tempoMedio: tempoMedio.value,
      data: dataInput.value
    });

    bopeForm.reset();
    setModoEdicao(false);
    renderOcorrencias();
  });

  renderOcorrencias();
</script>

</body>
</html>
